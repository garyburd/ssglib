<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<style>*, *::before, *::after { box-sizing: border-box; }
body {
  color: #111;
  background-color: #fefefe;
  max-width: 50rem;
  padding: 0 1rem 1rem 1rem;
  margin: 0 auto;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, sans-serif;
  line-height: 1.5;
}
nav.top ul { display: flex; flex-wrap: wrap; list-style: none; margin: 0; padding: 0; align-items: end; }
nav.top li:not(:first-child)::before { display: inline-block; margin: 0 0.25rem; content: "|"; }
nav.top li:first-child { font-weight: bold; font-size: 1.13em; }
nav.top a { text-decoration: none; }
nav.top a:hover { text-decoration: underline; }
body > header { margin-top: 1.25rem; margin-bottom: 1.7rem; }
a { color: #0366d6; }
a:hover { color: #0550ae; }
pre { background-color: #f6f8fa; padding: 1em; overflow-x: auto; border-radius: 6px; }
code { font-size: 0.9em; }
:not(pre) > code { background-color: #f6f8fa; padding: 0.15em 0.3em; border-radius: 3px; }
article > h1 { margin-bottom: 0.5rem; }
.callout { border-left: 3px solid #d0d7de; padding: 0.5em 1em; margin: 1em 0; }
.callout-note { border-left-color: #0366d6; }
.callout-warning { border-left-color: #d29922; }
</style>
<title>ssglib â€“ Filters</title>
</head>
<body>
<header><nav class="top">
<ul>
<li><a href="/ssglib/" title="Home">ssglib</a></li>
</ul>
</nav></header>
<main>
<article><h1>Filters</h1>
<p>The <code>ssglib.filters</code> module provides Pandoc filter
functions for processing Obsidian vault content. Filters are passed to
<code>doc:walk()</code> to transform a Pandoc document.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">filters</span> <span class="op">=</span> <span class="fu">require</span> <span class="st">&quot;ssglib.filters&quot;</span></span></code></pre></div>
<h2>callout_filter</h2>
<p>A filter function for <code>BlockQuote</code> elements. Converts
Obsidian callout syntax into Pandoc <code>Div</code> or
<code>Figure</code> elements.</p>
<p>Standard callouts become a <code>Div</code> with classes
<code>callout</code> and <code>callout-&lt;marker&gt;</code>:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">!warning</span><span class="co">]</span><span class="at"> This is important.</span></span></code></pre></div>
<p>Figure callouts become a <code>Figure</code> element with
caption:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; </span><span class="co">[</span><span class="ot">!figure</span><span class="co">]</span><span class="at"> ![</span><span class="co">[</span><span class="ot">photo.jpg</span><span class="co">]</span><span class="at">]</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; A photo caption.</span></span></code></pre></div>
<p>Usage:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">filter</span> <span class="op">=</span> <span class="op">{</span> <span class="va">BlockQuote</span> <span class="op">=</span> <span class="va">filters</span><span class="op">.</span><span class="va">callout_filter</span> <span class="op">}</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="va">doc</span> <span class="op">=</span> <span class="va">doc</span><span class="op">:</span>walk<span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<h2>make_link_filter(vault)</h2>
<p>Create a <code>Link</code> filter that resolves vault wikilinks to
URLs. Links to files not found in the vault are left unchanged.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">filter</span> <span class="op">=</span> <span class="op">{</span> <span class="va">Link</span> <span class="op">=</span> <span class="va">filters</span><span class="op">.</span>make_link_filter<span class="op">(</span><span class="va">vault</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="va">doc</span> <span class="op">=</span> <span class="va">doc</span><span class="op">:</span>walk<span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<p>Given a vault note <code>Hello World.md</code> with
<code>permalink: hello/</code>, a wikilink <code>[[Hello World]]</code>
becomes a link to <code>/hello/</code>.</p>
<h2>make_image_filter(vault, site)</h2>
<p>Create an <code>Image</code> filter that copies images from the vault
to the site and generates responsive <code>srcset</code> attributes. The
filter creates multiple resized versions of each image.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">filter</span> <span class="op">=</span> <span class="op">{</span> <span class="va">Image</span> <span class="op">=</span> <span class="va">filters</span><span class="op">.</span>make_image_filter<span class="op">(</span><span class="va">vault</span><span class="op">,</span> <span class="va">site</span><span class="op">)</span> <span class="op">}</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="va">doc</span> <span class="op">=</span> <span class="va">doc</span><span class="op">:</span>walk<span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<div class="callout callout-note">
<p>This filter requires GraphicsMagick (<code>gm convert</code>) for
image resizing.</p>
</div>
<h2>make_codeblock_filter(env, ...)</h2>
<p>Create a <code>CodeBlock</code> filter that executes code blocks with
the <code>eval</code> class. The code is run in the provided environment
table and the return value replaces the code block in the document.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode lua"><code class="sourceCode lua"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">local</span> <span class="va">filter</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">CodeBlock</span> <span class="op">=</span> <span class="va">filters</span><span class="op">.</span>make_codeblock_filter<span class="op">(</span>overlay<span class="op">(</span><span class="va">_G</span><span class="op">,</span> <span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">contents</span> <span class="op">=</span> <span class="kw">function</span><span class="op">()</span> <span class="cf">return</span> build_contents_list<span class="op">()</span> <span class="kw">end</span><span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">})),</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="va">doc</span> <span class="op">=</span> <span class="va">doc</span><span class="op">:</span>walk<span class="op">(</span><span class="va">filter</span><span class="op">)</span></span></code></pre></div>
<p>In a markdown file, an evaluated code block looks like this:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="in">```eval</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="in">contents()</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span></code></pre></div>
<p>The expression is evaluated and its return value (typically a Pandoc
AST element) replaces the code block. If evaluation fails, the error
message is shown in a code block.</p></article>
</main>
</body>
</html>
